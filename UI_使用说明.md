# SQL Server 日志监控器 UI 使用说明

## 界面概览

新版本的SQL Server日志监控器采用现代化的多标签页设计，包含5个主要功能模块：

- **SQL Server 监控** - 专用的SQL Server登录日志监控
- **通用日志监控** - 传统的Windows事件日志监控
- **配置管理** - 全面的系统配置选项
- **服务管理** - Windows服务的安装和管理
- **状态统计** - 运行统计和错误信息

## 详细功能说明

### 1. SQL Server 监控标签页

这是新增的核心功能，专门用于监控SQL Server的登录活动。

#### 功能区域

**配置区域**
- **启用SQL Server监控**: 主开关，控制是否启用SQL Server监控功能
- **包含MSSQLSERVER事件**: 监控来自MSSQLSERVER源的事件（事件ID 18453/18456）
- **包含Windows身份验证**: 监控Windows身份验证相关的登录事件
- **监控间隔(秒)**: 设置日志收集的时间间隔（10-3600秒）
- **批处理大小**: 每次处理的日志条数（1-100条）

**控制按钮**
- **启动监控**: 开始SQL Server日志监控
- **停止监控**: 停止SQL Server日志监控
- **状态显示**: 实时显示监控状态
- **日志数量**: 显示当前收集的日志数量

**日志显示区域**
显示收集到的SQL Server登录日志，包含以下列：
- **时间**: 日志生成时间
- **类型**: 登录类型（SQL登录成功/失败、Windows登录成功/失败）
- **用户名**: 登录用户名
- **客户端IP**: 客户端IP地址
- **数据库**: 访问的数据库名称
- **事件ID**: Windows事件ID
- **消息**: 详细的日志消息

#### 使用步骤

1. 确保已启用SQL Server登录审计（参考PowerShell脚本）
2. 勾选"启用SQL Server监控"
3. 配置监控参数（间隔、批处理大小等）
4. 点击"启动监控"开始监控
5. 在下方表格中查看实时的登录日志
6. 日志会自动上传到配置的API端点

### 2. 通用日志监控标签页

这是传统的Windows事件日志监控功能，保持向后兼容。

#### 功能区域

**控制面板**
- **事件源**: 选择要监控的事件源（MSSQLSERVER、PerfProc等）
- **加载日志**: 加载选定事件源的历史日志
- **推送日志**: 手动推送未上传的日志
- **开始监控**: 开始实时监控选定的事件源

**日志显示区域**
显示传统格式的Windows事件日志

#### 使用步骤

1. 从下拉列表选择事件源
2. 点击"加载日志"查看历史日志
3. 点击"推送日志"手动上传
4. 或点击"开始监控"进行实时监控

### 3. 配置管理标签页

集中管理所有系统配置选项。

#### 配置组

**API配置**
- **API地址**: 远程日志服务器的API地址
- **API密钥**: 用于身份验证的API密钥
- **强制使用HTTPS**: 确保连接安全
- **超时(秒)**: API请求超时时间

**重试策略**
- **启用重试机制**: 上传失败时是否自动重试
- **最大重试次数**: 最多重试几次
- **重试延迟(秒)**: 重试之间的等待时间

**日志保留设置**
- **保留天数**: 本地日志文件保留天数
- **最大文件大小(KB)**: 日志文件的最大大小

#### 操作按钮

- **保存配置**: 保存所有配置到文件
- **测试连接**: 测试API连接是否正常

#### 使用步骤

1. 配置API地址和密钥
2. 根据需要调整重试策略
3. 设置合适的日志保留策略
4. 点击"测试连接"验证配置
5. 点击"保存配置"保存设置

### 4. 服务管理标签页

管理Windows服务的安装、启动和停止。

#### 功能区域

**服务管理控制**
- **安装服务**: 将程序安装为Windows服务
- **卸载服务**: 移除Windows服务
- **启动服务**: 启动监控服务
- **停止服务**: 停止监控服务
- **服务状态**: 显示当前服务状态

**服务日志显示**
实时显示服务运行日志，采用控制台风格的黑底绿字显示。

#### 使用步骤

1. 以管理员身份运行程序
2. 点击"安装服务"安装Windows服务
3. 点击"启动服务"启动后台监控
4. 在日志区域查看服务运行状态
5. 需要时可以停止或卸载服务

#### 注意事项

- 服务安装/卸载需要管理员权限
- 服务启动后会在后台持续运行
- 可以通过Windows服务管理器查看服务状态

### 5. 状态统计标签页

显示系统运行状态和统计信息。

#### 统计信息

**运行统计**
- **已处理日志**: 总共处理的日志条数
- **已上传日志**: 成功上传的日志条数
- **上传错误**: 上传失败的次数
- **最后上传**: 最后一次成功上传的时间
- **进度条**: 上传成功率的可视化显示

**错误日志显示**
显示最近的错误信息，包含：
- **时间**: 错误发生时间
- **错误信息**: 错误类型
- **详细信息**: 错误详细描述

#### 操作按钮

- **清除错误记录**: 清空错误历史记录

#### 使用场景

- 监控系统运行健康状况
- 排查上传失败问题
- 查看系统性能统计

## 系统托盘功能

程序支持最小化到系统托盘，提供以下快捷操作：

- **显示主界面**: 恢复主窗口
- **启动SQL Server监控**: 快速启动监控
- **停止SQL Server监控**: 快速停止监控
- **退出**: 完全退出程序

## 常见使用场景

### 场景1：首次部署

1. 运行PowerShell脚本配置SQL Server审计
2. 在"配置管理"中设置API地址和密钥
3. 测试API连接
4. 保存配置
5. 在"SQL Server监控"中启动监控
6. 可选：安装为Windows服务实现自动启动

### 场景2：日常监控

1. 通过系统托盘图标快速启动/停止监控
2. 在"状态统计"中查看运行情况
3. 定期检查错误信息
4. 根据需要调整监控参数

### 场景3：故障排除

1. 在"状态统计"中查看错误信息
2. 在"服务管理"中查看服务日志
3. 在"配置管理"中测试API连接
4. 检查SQL Server审计配置
5. 查看本地日志文件

## 技巧和最佳实践

### 性能优化

- 根据日志产生频率调整监控间隔
- 适当设置批处理大小减少网络请求
- 定期清理本地日志文件

### 安全配置

- 使用HTTPS协议传输日志
- 定期更换API密钥
- 限制日志文件的访问权限

### 可靠性保证

- 启用重试机制应对网络波动
- 安装为Windows服务确保自动启动
- 设置合适的日志保留期避免磁盘空间不足

## 常见问题

**Q: SQL Server监控无法启动？**
A: 检查是否已启用SQL Server登录审计，确保配置了正确的API地址。

**Q: 看不到登录成功的日志？**
A: 运行PowerShell脚本启用SQL Server审计级别为3，并重启SQL Server服务。

**Q: 服务安装失败？**
A: 确保以管理员身份运行程序，检查Windows服务权限。

**Q: 日志上传失败？**
A: 检查网络连接、API地址和密钥，在配置管理中测试连接。

**Q: 程序运行缓慢？**
A: 增加监控间隔，减少批处理大小，清理本地日志文件。 